<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Secure IRS Portal</title>
    <link rel="stylesheet" href="css/style.css">
    <link rel="stylesheet" href="css/irs.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="icon" type="image/png" href="assets/logoo.png">

</head>
<body class="irs-portal">
    <!-- IRS Header -->
    <header class="irs-header">
        <div class="header-content">
            <div class="irs-logo">
                <div class="irs-seal">
                    <i class="fas fa-university"></i>
                </div>
                <div class="logo-text">
                    <h1>Secure IRS Portal</h1>
                    <p>Internal Revenue Service • Financial Management System</p>
                </div>
            </div>
            
            <div class="header-controls">
                <div class="security-indicator critical">
                    <i class="fas fa-shield-alt"></i>
                    <span>SECURE CONNECTION • ENCRYPTED</span>
                </div>
                
                <div class="session-info">
                    <div class="session-timer">
                        <i class="fas fa-clock"></i>
                        <span>Auto-logout: <span id="irsTimer">05:00</span></span>
                    </div>
                    
                    <button class="logout-btn" id="irsLogoutBtn">
                        <i class="fas fa-sign-out-alt"></i>
                        <span>Secure Exit</span>
                    </button>
                </div>
            </div>
        </div>
    </header>
    
    <!-- Main Content -->
    <main class="irs-container">
        <!-- Account Overview -->
        <section class="account-overview">
            <div class="section-header">
                <h2><i class="fas fa-wallet"></i> Account Overview</h2>
                <div class="last-updated">
                    <i class="fas fa-sync-alt"></i>
                    <span>Updated</span>
                </div>
            </div>
            
            <div class="balance-display">
                <div class="balance-label">Holdings from XOM shares</div>
                <div class="balance-amount" id="currentBalance">$42,300,000.00</div>
                <div class="balance-subtext">~154,024,857.00 Qatari Rial</div>
            </div>
            
            <div class="balance-history">
                <h3>Balance History (Last 6 Months)</h3>
                <div class="chart-wrapper">
                    <canvas id="balanceChart"></canvas>
                </div>
            </div>
        </section>
        
        <!-- Withdrawal Panel -->
        <section class="withdrawal-panel">
            <div class="section-header">
                <h2><i class="fas fa-money-check-alt"></i> Withdrawal Request</h2>
                <div class="withdrawal-limit">
                    <i class="fas fa-exclamation-circle"></i>
                    <span>Daily Limit: $10,000.00</span>
                </div>
            </div>
            
            <form id="withdrawalForm">
                <div class="form-grid">
                    <div class="form-group">
                        <label for="withdrawalAmount">
                            <i class="fas fa-dollar-sign"></i> Amount
                        </label>
                        <div class="amount-input">
                            <span class="currency-symbol">$</span>
                            <input type="number" id="withdrawalAmount" 
                                   min="1" max="10000" 
                                   step="0.01" 
                                   placeholder="0.00"
                                   required>
                        </div>
                        <div class="amount-hint">
                            Maximum withdrawal: $10,000.00
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label for="withdrawalMethod">
                            <i class="fas fa-truck"></i> Method
                        </label>
                        <select id="withdrawalMethod" required>
                            <option value="">Select method</option>
                            <option value="bank">Bank Transfer (1-2 business days)</option>
                            <option value="wire">Wire Transfer (Same day)</option>
                            <option value="check">Check (5-7 business days)</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label for="accountSelection">
                            <i class="fas fa-piggy-bank"></i> Account
                        </label>
                        <select id="accountSelection" required>
                            <option value="">Select account</option>
                            <option value="primary">Primary Checking •••• 4829</option>
                            <option value="savings">Savings Account •••• 1735</option>
                        </select>
                    </div>
                </div>
                
                <div class="form-actions">
                    <button type="button" class="btn-secondary" id="cancelWithdrawal">
                        Cancel
                    </button>
                    <button type="submit" class="btn-primary" id="reviewWithdrawal">
                        <i class="fas fa-search-dollar"></i>
                        Review Withdrawal
                    </button>
                </div>
            </form>
        </section>
        
        <!-- Recent Transactions -->
        <section class="transactions-section">
            <div class="section-header">
                <h2><i class="fas fa-history"></i> Recent Transactions</h2>
                <button class="export-btn" id="exportTransactions">
                    <i class="fas fa-download"></i>
                    <span>Export CSV</span>
                </button>
            </div>
            
            <div class="transactions-table">
                <table>
                    <thead>
                        <tr>
                            <th>Date</th>
                            <th>Description</th>
                            <th>Type</th>
                            <th>Amount</th>
                            <th>Reference</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody id="transactionsBody">
                        <!-- Transactions will be loaded by JS -->
                    </tbody>
                </table>
            </div>
        </section>
    </main>
    
    <!-- Confirmation Modal -->
    <div class="modal-overlay hidden" id="confirmationModal">
        <div class="modal-content confirmation-modal">
            <div class="modal-header">
                <h2><i class="fas fa-check-circle"></i> Confirm Withdrawal</h2>
                <button class="close-modal" id="closeConfirmation">&times;</button>
            </div>
            
            <div class="modal-body">
                <div class="confirmation-details">
                    <div class="detail-row">
                        <span class="detail-label">Amount:</span>
                        <span class="detail-value" id="confirmAmount">$0.00</span>
                    </div>
                    <div class="detail-row">
                        <span class="detail-label">Method:</span>
                        <span class="detail-value" id="confirmMethod">Bank Transfer</span>
                    </div>
                    <div class="detail-row">
                        <span class="detail-label">Account:</span>
                        <span class="detail-value" id="confirmAccount">Primary Checking</span>
                    </div>
                    <div class="detail-row">
                        <span class="detail-label">Fee:</span>
                        <span class="detail-value">$0.00</span>
                    </div>
                    <div class="detail-row total">
                        <span class="detail-label">Total:</span>
                        <span class="detail-value" id="confirmTotal">$0.00</span>
                    </div>
                </div>
                
                <div class="security-verification">
                    <h3><i class="fas fa-user-shield"></i> Security Verification</h3>
                    <p>Enter your password to confirm this transaction:</p>
                    
                    <div class="verification-input">
                        <label for="confirmPassword">
                            <i class="fas fa-lock"></i> Password
                        </label>
                        <input type="password" id="confirmPassword" placeholder="Enter your password">
                    </div>
                    
                    <div class="modal-buttons">
                        <button type="button" class="btn-secondary" id="cancelConfirmation">
                            Cancel
                        </button>
                        <button type="button" class="btn-primary" id="confirmTransaction">
                            <i class="fas fa-check"></i>
                            Confirm Withdrawal
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Success Modal -->
    <div class="modal-overlay hidden" id="successModal">
        <div class="modal-content success-modal">
            <div class="modal-header">
                <h2><i class="fas fa-check-circle success-icon"></i> Withdrawal Successful</h2>
            </div>
            
            <div class="modal-body">
                <div class="success-message">
                    <p>Your withdrawal request has been processed successfully.</p>
                    <div class="transaction-id">
                        <strong>Transaction ID:</strong>
                        <code id="transactionId">TX-2024-8573-2918</code>
                    </div>
                    <div class="success-details">
                        <p>Funds will be available in your account within 1-2 business days.</p>
                        <p>A confirmation email has been sent to your registered address.</p>
                    </div>
                </div>
                
                <div class="modal-buttons">
                    <button type="button" class="btn-primary" id="closeSuccess">
                        Return to Dashboard
                    </button>
                </div>
            </div>
        </div>
    </div>
    
    <script src="js/utils.js"></script>
    <script src="js/auth.js"></script>
    <script src="js/irs.js"></script>
    <script>
        // Initialize IRS Portal
document.addEventListener('DOMContentLoaded', function() {
    // Check authentication
    if (!Auth.isAuthenticated()) {
        window.location.href = 'index.html';
        return;
    }
    
    // Check if user has valid token access for this session
    // if (!Auth.hasValidTokenAccess()) {
    //     alert('IRS access token required. Please obtain a token from the dashboard.');
    //     window.location.href = 'dashboard.html';
    //     return;
    // }
    
    // Initialize IRS module
    IRS.init();
    
    // Setup event listeners
    setupIRSEvents();
    startIRSTimer();
    loadTransactions();
});
        
        function setupIRSEvents() {
            // Logout button
            document.getElementById('irsLogoutBtn').addEventListener('click', function() {
            //Deactivate token session
            Auth.deactivateTokenSession();
             Auth.logout();
            window.location.href = 'index.html';
            });
            
            // Withdrawal form
            const withdrawalForm = document.getElementById('withdrawalForm');
            withdrawalForm.addEventListener('submit', function(e) {
                e.preventDefault();
                showConfirmationModal();
            });
            
            // Cancel withdrawal
            document.getElementById('cancelWithdrawal').addEventListener('click', function() {
                withdrawalForm.reset();
            });
            
            // Export transactions
            document.getElementById('exportTransactions').addEventListener('click', function() {
                IRS.exportTransactions();
            });
            
            // Confirmation modal
            document.getElementById('closeConfirmation').addEventListener('click', closeConfirmation);
            document.getElementById('cancelConfirmation').addEventListener('click', closeConfirmation);
            
            // Confirm transaction
            document.getElementById('confirmTransaction').addEventListener('click', processWithdrawal);
            
            // Close success modal
            document.getElementById('closeSuccess').addEventListener('click', function() {
                document.getElementById('successModal').classList.add('hidden');
                window.location.href = 'dashboard.html';
            });
            
            // Amount input validation
            const amountInput = document.getElementById('withdrawalAmount');
            amountInput.addEventListener('input', function() {
                const maxAmount = 10000;
                if (parseFloat(this.value) > maxAmount) {
                    this.value = maxAmount;
                }
            });
        }
        
        function showConfirmationModal() {
            const amount = document.getElementById('withdrawalAmount').value;
            const method = document.getElementById('withdrawalMethod');
            const account = document.getElementById('accountSelection');
            
            if (!amount || !method.value || !account.value) {
                alert('Please fill all fields');
                return;
            }
            
            // Update confirmation modal
            document.getElementById('confirmAmount').textContent = '$' + parseFloat(amount).toFixed(2);
            document.getElementById('confirmMethod').textContent = method.options[method.selectedIndex].text;
            document.getElementById('confirmAccount').textContent = account.options[account.selectedIndex].text;
            document.getElementById('confirmTotal').textContent = '$' + parseFloat(amount).toFixed(2);
            
            // Show modal
            document.getElementById('confirmationModal').classList.remove('hidden');
        }
        
        function closeConfirmation() {
            document.getElementById('confirmationModal').classList.add('hidden');
            document.getElementById('confirmPassword').value = '';
        }
        
        function processWithdrawal() {
            const password = document.getElementById('confirmPassword').value;
            
            if (password !== 'Godisgood') {
                alert('Invalid password. Please try again.');
                return;
            }
            
            // Process withdrawal
            const amount = parseFloat(document.getElementById('withdrawalAmount').value);
            const success = IRS.processWithdrawal(amount);
            
            if (success) {
                closeConfirmation();
                showSuccessModal();
            }
        }
        
        function showSuccessModal() {
            // Generate random transaction ID
            const txId = 'TX-' + new Date().getFullYear() + '-' + 
                Math.floor(Math.random() * 10000).toString().padStart(4, '0') + '-' +
                Math.floor(Math.random() * 10000).toString().padStart(4, '0');
            
            document.getElementById('transactionId').textContent = txId;
            document.getElementById('successModal').classList.remove('hidden');
            
            // Reset form
            document.getElementById('withdrawalForm').reset();
            
            // Update balance
            updateBalanceAfterWithdrawal();
        }
        
        function updateBalanceAfterWithdrawal() {
            const amount = parseFloat(document.getElementById('withdrawalAmount').value);
            const currentBalance = document.getElementById('currentBalance');
            const balance = parseFloat(currentBalance.textContent.replace('$', '').replace(',', ''));
            const newBalance = balance - amount;
            
            currentBalance.textContent = '$' + newBalance.toLocaleString('en-US', {
                minimumFractionDigits: 2,
                maximumFractionDigits: 2
            });
            
            // Add to transaction history
            loadTransactions();
        }
        
        function startIRSTimer() {
            const timerElement = document.getElementById('irsTimer');
            let minutes = 5;
            let seconds = 0;
            
            const timer = setInterval(() => {
                timerElement.textContent = `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
                
                if (seconds === 0) {
                    if (minutes === 0) {
                        clearInterval(timer);
                        sessionStorage.removeItem('tokenAccessed');
                        Auth.logout();
                        alert('Session expired. Please login again.');
                        window.location.href = 'index.html';
                    } else {
                        minutes--;
                        seconds = 59;
                    }
                } else {
                    seconds--;
                }
            }, 1000);
        }
        
        // function loadTransactions() {
        //     const transactions = IRS.getTransactions();
        //     const tbody = document.getElementById('transactionsBody');
        //     tbody.innerHTML = '';
            
        //     transactions.forEach(transaction => {
        //         const row = document.createElement('tr');
                
        //         // Status badge
        //         let statusClass = '';
        //         let statusIcon = '';
        //         switch(transaction.status) {
        //             case 'Completed':
        //                 statusClass = 'status-completed';
        //                 statusIcon = '<i class="fas fa-check-circle"></i>';
        //                 break;
        //             case 'Pending':
        //                 statusClass = 'status-pending';
        //                 statusIcon = '<i class="fas fa-clock"></i>';
        //                 break;
        //             case 'Failed':
        //                 statusClass = 'status-failed';
        //                 statusIcon = '<i class="fas fa-times-circle"></i>';
        //                 break;
        //         }
                
        //         row.innerHTML = `
        //             <td>${transaction.date}</td>
        //             <td>${transaction.description}</td>
        //             <td>${transaction.type}</td>
        //             <td class="${transaction.amount < 0 ? 'negative' : 'positive'}">
        //                 ${transaction.amount < 0 ? '-' : '+'}$${Math.abs(transaction.amount).toFixed(2)}
        //             </td>
        //             <td>
        //                 <span class="status-badge ${statusClass}">
        //                     ${statusIcon} ${transaction.status}
        //                 </span>
        //             </td>
        //             <td><code>${transaction.reference}</code></td>
        //         `;
                
        //         tbody.appendChild(row);
        //     });
        // }
        // Update the loadTransactions function in irs-portal.html
            // Updated loadTransactions function to show only one record
function loadTransactions() {
    const transactions = IRS.getTransactions();
    const tbody = document.getElementById('transactionsBody');
    
    if (!tbody) return;
    
    tbody.innerHTML = '';
    
    // Show only the most recent transaction (1 record)
    const recentTransactions = transactions.slice(0, 1);
    
    recentTransactions.forEach((transaction, index) => {
        const row = document.createElement('tr');
        
        // Status badge
        let statusClass = '';
        let statusIcon = '';
        switch(transaction.status) {
            
        }
        
        // Amount styling
        const amountClass = transaction.amount < 0 ? 'negative' : 'positive';
        const amountSign = transaction.amount < 0 ? '-' : '+';
        const amountDisplay = Math.abs(transaction.amount).toFixed(2);
        
        row.innerHTML = `
            <td>${transaction.date}</td>
            <td>${transaction.description}</td>
            <td>${transaction.type}</td>
            <td class="${amountClass}">
                ${amountSign}$${amountDisplay}
            </td>
            
            <td><code>${transaction.reference}</code></td>
            <td>
                <button class="delete-btn" data-index="${index}" title="Delete transaction">
                    <i class="fas fa-trash"></i>
                </button>
            </td>
        `;
        
        tbody.appendChild(row);
    });
    
    // If no transactions, show a message
    if (recentTransactions.length === 0) {
        const row = document.createElement('tr');
        row.innerHTML = `
            <td colspan="7" class="no-transactions">
                <i class="fas fa-history"></i>
                <span>No recent transactions</span>
            </td>
        `;
        tbody.appendChild(row);
    }
    
    // Add delete button event listeners
    document.querySelectorAll('.delete-btn').forEach(btn => {
        btn.addEventListener('click', function() {
            const index = parseInt(this.dataset.index);
            if (confirm('Are you sure you want to delete this transaction?')) {
                IRS.deleteTransaction(index);
                loadTransactions(); // Reload the table
            }
        });
    });
}
    </script>
</body>
</html>